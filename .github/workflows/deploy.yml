name: Deploy Sapphire AI to GKE

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  PROJECT_ID: sapphireinfinite
  GKE_CLUSTER: hft-trading-cluster
  GKE_ZONE: us-central1-a
  IMAGE: cloud-trader

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Lint Python Code
        run: |
          pip install flake8 black isort bandit
          black --check cloud_trader/ || true
          isort --check-only cloud_trader/ || true
          flake8 cloud_trader/ --count --select=E9,F63,F7,F82 || true
          echo "Running security scan with bandit..."
          bandit -r cloud_trader/ || true

      - name: Run Tests
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov
          pytest tests/ -v || true

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker us-central1-docker.pkg.dev

      - name: Build Docker Image
        run: |
          docker build \
            --build-arg CACHE_BUST=${{ github.sha }} \
            -t us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-source-deploy/$IMAGE:${{ github.sha }} \
            -t us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-source-deploy/$IMAGE:latest \
            .

      - name: Push Docker Image
        run: |
          docker push us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-source-deploy/$IMAGE:${{ github.sha }}
          docker push us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-source-deploy/$IMAGE:latest

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.12.1'

      - name: Validate Helm Chart
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm dependency build ./helm/trading-system
          helm lint ./helm/trading-system
          helm template ./helm/trading-system | grep -A8 "readinessProbe"

      - name: Get GKE Credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ env.GKE_CLUSTER }}
          location: ${{ env.GKE_ZONE }}

      - name: Deploy to GKE
        run: |
          helm upgrade --install trading-system ./helm/trading-system \
            --namespace trading \
            --create-namespace \
            -f helm/trading-system/values-emergency-minimal.yaml \
            --set cloudTrader.image.tag=${{ github.sha }} \
            --timeout 5m

          kubectl rollout status deployment/trading-system-cloud-trader -n trading --timeout=10m

      - name: Verify Deployment
        run: |
          kubectl get pods -n trading
          kubectl get services -n trading
          echo "âœ… Deployment successful"
