{{- if .Values.telegram.dailyRecap.enabled }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "trading-system.fullname" . }}-telegram-recap
  namespace: {{ .Values.global.namespace | default "trading" }}
  labels:
    {{- include "trading-system.labels" . | nindent 4 }}
    app: telegram-recap
spec:
  schedule: {{ .Values.telegram.dailyRecap.schedule | default "0 0 * * *" }}  # Daily at midnight UTC
  timeZone: UTC
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            {{- include "trading-system.selectorLabels" . | nindent 8 }}
            app: telegram-recap
        spec:
          serviceAccountName: {{ include "trading-system.serviceAccountName" . }}
          containers:
          - name: telegram-recap
            image: {{ $.Values.global.imageRegistry }}/{{ $.Values.global.projectId }}/cloud-run-source-deploy/cloud-trader:{{ $.Values.cloudTrader.image.tag | default "latest" }}
            imagePullPolicy: {{ $.Values.global.imagePullPolicy }}
            command: 
            - python3
            - -c
            - |
              import asyncio
              import os
              from cloud_trader.config import get_settings
              from cloud_trader.telegram_recaps import create_recap_service
              
              async def main():
                  settings = get_settings()
                  recap_service = await create_recap_service(settings)
                  if recap_service:
                      hours = int(os.getenv('RECAP_HOURS', '24'))
                      await recap_service.send_recap(hours=hours, include_chart=True)
                      print(f"✅ Daily recap sent successfully ({hours}h)")
                  else:
                      print("❌ Recap service not available")
              
              asyncio.run(main())
            env:
            {{- include "trading-system.commonEnv" . | nindent 12 }}
            - name: RECAP_HOURS
              value: {{ .Values.telegram.dailyRecap.hours | default "24" | quote }}
            - name: TELEGRAM_DAILY_RECAP_ENABLED
              value: "true"
            envFrom:
            - secretRef:
                name: cloud-trader-secrets
            resources:
              requests:
                cpu: 100m
                memory: 256Mi
              limits:
                cpu: 500m
                memory: 512Mi
          restartPolicy: OnFailure
{{- end }}

