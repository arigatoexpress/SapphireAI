{{- if .Values.telegram.dailyRecap.enabled }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "trading-system.fullname" . }}-telegram-recap
  namespace: {{ .Values.global.namespace | default "trading" }}
  labels:
    {{- include "trading-system.labels" . | nindent 4 }}
    app: telegram-recap
spec:
  schedule: {{ .Values.telegram.dailyRecap.schedule | default "0 0 * * *" | quote }}
  timeZone: UTC
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            {{- include "trading-system.selectorLabels" . | nindent 12 }}
            app: telegram-recap
        spec:
          serviceAccountName: {{ include "trading-system.serviceAccountName" . }}
          containers:
          - name: telegram-recap
            image: {{ .Values.global.imageRegistry }}/{{ .Values.global.projectId }}/{{ .Values.cloudTrader.image.repository }}:{{ .Values.cloudTrader.image.tag }}
            imagePullPolicy: {{ .Values.global.imagePullPolicy }}
            command: ["python3", "/scripts/recap.py"]
            volumeMounts:
            - name: script
              mountPath: /scripts
            env:
            {{- include "trading-system.commonEnv" $ | nindent 12 }}
            - name: RECAP_HOURS
              value: {{ .Values.telegram.dailyRecap.hours | default "24" | quote }}
            - name: TELEGRAM_DAILY_RECAP_ENABLED
              value: "true"
            envFrom:
            - secretRef:
                name: cloud-trader-secrets
            resources:
              {{- toYaml .Values.cloudTrader.resources | nindent 14 }}
          volumes:
          - name: script
            configMap:
              name: {{ include "trading-system.fullname" . }}-telegram-recap-script
              items:
              - key: recap.py
                path: recap.py
          restartPolicy: OnFailure
{{- end }}
