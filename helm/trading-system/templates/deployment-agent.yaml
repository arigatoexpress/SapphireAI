{{- if .Values.agents.enabled }}
{{- range $agentName, $agentConfig := .Values.agents }}
{{- if ne $agentName "enabled" }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "trading-system.fullname" $ }}-{{ $agentName }}-bot
  namespace: trading
  labels:
    {{- include "trading-system.labels" $ | nindent 4 }}
    app: cloud-trader
    agent: {{ $agentName }}
spec:
  replicas: {{ $agentConfig.replicaCount }}
  selector:
    matchLabels:
      {{- include "trading-system.selectorLabels" $ | nindent 6 }}
      app: cloud-trader
      agent: {{ $agentName }}
  template:
    metadata:
      labels:
        {{- include "trading-system.selectorLabels" $ | nindent 8 }}
        app: cloud-trader
        agent: {{ $agentName }}
    spec:
      {{- with $.Values.securityContext }}
      securityContext:
        {{- toYaml . | nindent 8 }}
      {{- end }}
{{- if and $.Values.tpu.enabled (eq $agentName "vpin") }}
{{- with $.Values.nodeSelector }}
nodeSelector:
  {{- toYaml . | nindent 8 }}
{{- end }}
{{- with $.Values.tolerations }}
tolerations:
  {{- toYaml . | nindent 8 }}
{{- end }}
{{- end }}
      serviceAccountName: {{ include "trading-system.serviceAccountName" $ }}
      containers:
        - name: cloud-trader
          image: {{ $.Values.customImageRegistry }}/{{ $.Values.global.projectId }}/{{ $agentConfig.image.repository }}:{{ $agentConfig.image.tag }}
          imagePullPolicy: {{ $.Values.global.imagePullPolicy }}
          command: ["python3", "start.py"]
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          env:
            - name: ASTER_API_KEY
              valueFrom:
                secretKeyRef:
                  name: cloud-trader-secrets
                  key: ASTER_API_KEY
            - name: ASTER_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: cloud-trader-secrets
                  key: ASTER_SECRET_KEY
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: cloud-trader-secrets
                  key: DATABASE_URL
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: cloud-trader-secrets
                  key: DB_PASSWORD
            {{- include "trading-system.commonEnv" $ | nindent 12 }}
            - name: MCP_COORDINATOR_URL
              value: "http://{{ include "trading-system.fullname" $ }}-mcp-coordinator.trading.svc.cluster.local:{{ $.Values.mcpCoordinator.service.port }}"
            {{- with $agentConfig.env }}
            {{- toYaml . | nindent 12 }}
            {{- end }}
          envFrom:
            - secretRef:
                name: cloud-trader-secrets
          resources:
            {{- $resources := $agentConfig.resources }}
            {{- if and $.Values.tpu.enabled (ne $agentName "vpin") }}
              {{- $resources = omit $resources "limits" "requests" | merge (dict "limits" (omit $agentConfig.resources.limits "google.com/tpu") "requests" (omit $agentConfig.resources.requests "google.com/tpu")) }}
            {{- end }}
            {{- toYaml $resources | nindent 12 }}
          livenessProbe:
            httpGet:
              path: /healthz
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /healthz
              port: 8080
            {{- include "trading-system.readinessProbe" $ | nindent 12 }}
        {{- if $.Values.database.enabled }}
        - name: cloud-sql-proxy
          image: gcr.io/cloudsql-docker/gce-proxy:1.33.2
          command:
            - "/cloud_sql_proxy"
            - "-instances={{ $.Values.database.cloudSqlInstance }}=tcp:5432"
          securityContext:
            runAsNonRoot: true
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
        {{- end }}
{{- end }}
{{- end }}
{{- end }}
