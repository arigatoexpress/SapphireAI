{{- if .Values.systemInitialization.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "trading-system.fullname" . }}-system-init
  namespace: trading
  labels:
    {{- include "trading-system.labels" . | nindent 4 }}
    app: system-initializer
spec:
  backoffLimit: 3
  ttlSecondsAfterFinished: 300  # Clean up job after 5 minutes
  template:
    metadata:
      labels:
        {{- include "trading-system.selectorLabels" . | nindent 8 }}
        app: system-initializer
    spec:
      serviceAccountName: {{ include "trading-system.serviceAccountName" . }}
      restartPolicy: Never
      containers:
        - name: system-initializer
          image: {{ .Values.global.imageRegistry }}/{{ .Values.global.projectId }}/{{ .Values.systemInitialization.image.repository }}:{{ .Values.systemInitialization.image.tag }}
          imagePullPolicy: {{ .Values.global.imagePullPolicy }}
          command: ["python3", "/app/system_initializer.py"]
          env:
            {{- include "trading-system.commonEnv" . | nindent 12 }}
            - name: LOG_LEVEL
              value: "INFO"
            - name: INITIALIZATION_TIMEOUT
              value: "900"  # 15 minutes
          resources:
            {{- toYaml .Values.systemInitialization.resources | nindent 12 }}
          # Wait for all services to be ready
          readinessProbe:
            exec:
              command:
                - sh
                - -c
                - |
                  #!/bin/sh
                  # Check if all required services are ready
                  kubectl get pods -n trading --no-headers | grep -E "(cloud-trader|mcp-coordinator|deepseek-bot|qwen-bot)" | grep -c "Running" | xargs test 5 -le
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 60  # Wait up to 10 minutes for services
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
{{- end }}
