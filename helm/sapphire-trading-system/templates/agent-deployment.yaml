{{- if .Values.agents.enabled }}
{{- $agentConfigs := dict
  "trendMomentumAgent" (dict "id" "trend-momentum-agent" "name" "Trend Momentum Agent")
  "strategyOptimizationAgent" (dict "id" "strategy-optimization-agent" "name" "Strategy Optimization Agent")
  "financialSentimentAgent" (dict "id" "financial-sentiment-agent" "name" "Financial Sentiment Agent")
  "marketPredictionAgent" (dict "id" "market-prediction-agent" "name" "Market Prediction Agent")
  "volumeMicrostructureAgent" (dict "id" "volume-microstructure-agent" "name" "Volume Microstructure Agent")
  "vpinHftAgent" (dict "id" "vpin-hft" "name" "VPIN HFT Agent")
}}

{{- range $agentKey, $agentConfig := $agentConfigs }}
{{- $agentValues := index $.Values.agents $agentKey }}
{{- if $agentValues.enabled }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "sapphire-trading-system.fullname" $ }}-{{$agentConfig.id}}
  labels:
    {{- include "sapphire-trading-system.labels" $ | nindent 4 }}
    app.kubernetes.io/component: trading-agent
    sapphire-trading/agent-id: {{$agentConfig.id}}
spec:
  replicas: 1
  selector:
    matchLabels:
      {{- include "sapphire-trading-system.selectorLabels" $ | nindent 6 }}
      app.kubernetes.io/component: trading-agent
      sapphire-trading/agent-id: {{$agentConfig.id}}
  template:
    metadata:
      labels:
        {{- include "sapphire-trading-system.selectorLabels" $ | nindent 8 }}
        app.kubernetes.io/component: trading-agent
        sapphire-trading/agent-id: {{$agentConfig.id}}
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/secrets.yaml") $ | sha256sum }}
    spec:
      {{- include "sapphire-trading-system.podSecurityContext" $ | nindent 6 }}
      containers:
        - name: {{$agentConfig.id}}
          image: {{ $.Values.global.imageRegistry | default "" }}/{{ $.Values.agents.common.image.repository | default "cloud-run-source-deploy/cloud-trader" }}:{{ $.Values.agents.common.image.tag | default $.Values.trading.image.tag | default $.Chart.AppVersion | default "latest" }}
          imagePullPolicy: {{ include "sapphire-trading-system.imagePullPolicy" $ }}
          command:
            - "python"
            - "-c"
            - "import time; print('Agent {{$agentConfig.name}} starting...'); time.sleep(300)"
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          env:
            {{- include "sapphire-trading-system.env" $agentValues.env | nindent 12 }}
            - name: LOG_LEVEL
              valueFrom:
                configMapKeyRef:
                  name: {{ include "sapphire-trading-system.fullname" $ }}-config
                  key: LOG_LEVEL
          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 3
            failureThreshold: 3
          {{- include "sapphire-trading-system.resources" $.Values.agents.common.resources | nindent 10 }}
      {{- with $.Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with $.Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with $.Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "sapphire-trading-system.fullname" $ }}-{{$agentConfig.id}}
  labels:
    {{- include "sapphire-trading-system.labels" $ | nindent 4 }}
    app.kubernetes.io/component: trading-agent
    sapphire-trading/agent-id: {{$agentConfig.id}}
spec:
  type: ClusterIP
  ports:
    - port: 8080
      targetPort: 8080
      protocol: TCP
      name: http
  selector:
    {{- include "sapphire-trading-system.selectorLabels" $ | nindent 4 }}
    app.kubernetes.io/component: trading-agent
    sapphire-trading/agent-id: {{$agentConfig.id}}
{{- end }}
{{- end }}
{{- end }}
