#!/bin/bash

# Multi-Agent Deployment Script
# Safe deployment of trading agents on established infrastructure

set -e

NAMESPACE="trading-system"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Validate infrastructure is ready
validate_infrastructure() {
    log_info "Validating infrastructure readiness..."
    
    # Check namespace exists
    if ! kubectl get namespace "$NAMESPACE" >/dev/null 2>&1; then
        log_error "Namespace $NAMESPACE does not exist. Run ./deploy-infrastructure.sh first"
        exit 1
    fi
    
    # Check core services are running
    local core_services=("redis" "trading-coordinator")
    for service in "${core_services[@]}"; do
        if ! kubectl get deployment "$service" -n "$NAMESPACE" >/dev/null 2>&1; then
            log_error "Core service $service not found. Infrastructure not ready"
            exit 1
        fi
        
        # Check if deployment is ready
        local ready_replicas
        ready_replicas=$(kubectl get deployment "$service" -n "$NAMESPACE" -o jsonpath='{.status.readyReplicas}' 2>/dev/null || echo "0")
        if [ "$ready_replicas" != "1" ]; then
            log_error "Core service $service is not ready"
            exit 1
        fi
    done
    
    log_success "Infrastructure validation passed"
}

# Get Vertex AI model for agent
get_vertex_model_for_agent() {
    local agent_name="$1"
    case "$agent_name" in
        trend-momentum-agent)
            echo "gemini-2.0-flash-exp"
            ;;
        strategy-optimization-agent)
            echo "gemini-exp-1206"
            ;;
        financial-sentiment-agent)
            echo "gemini-2.0-flash-exp"
            ;;
        market-prediction-agent)
            echo "gemini-exp-1206"
            ;;
        volume-microstructure-agent)
            echo "codey-001"
            ;;
        vpin-hft)
            echo "gemini-2.0-flash-exp"
            ;;
        *)
            echo "gemini-2.0-flash-exp"  # Default
            ;;
    esac
}

# Get model temperature based on agent (agent-specific optimization)
get_model_temperature() {
    local agent_name="$1"
    case "$agent_name" in
        trend-momentum-agent)
            echo "0.1"  # Low temperature for precise momentum signals
            ;;
        strategy-optimization-agent)
            echo "0.3"  # Moderate temperature for strategy innovation
            ;;
        financial-sentiment-agent)
            echo "0.2"  # Low temperature for consistent sentiment analysis
            ;;
        market-prediction-agent)
            echo "0.4"  # Moderate creativity for market scenarios
            ;;
        volume-microstructure-agent)
            echo "0.1"  # Low temperature for precise volume calculations
            ;;
        vpin-hft)
            echo "0.1"  # Low temperature for fast, precise HFT signals
            ;;
        *)
            echo "0.1"  # Default
            ;;
    esac
}

# Get max output tokens based on agent (agent-specific optimization)
get_max_tokens() {
    local agent_name="$1"
    case "$agent_name" in
        trend-momentum-agent)
            echo "512"  # Concise responses for momentum signals
            ;;
        strategy-optimization-agent)
            echo "1024"  # Detailed responses for strategy analysis
            ;;
        financial-sentiment-agent)
            echo "256"  # Concise sentiment scores
            ;;
        market-prediction-agent)
            echo "768"  # Detailed prediction analysis
            ;;
        volume-microstructure-agent)
            echo "1024"  # Detailed volume analysis
            ;;
        vpin-hft)
            echo "512"  # Concise responses for HFT signals
            ;;
        *)
            echo "512"  # Default
            ;;
    esac
}

# Create agent manifest
create_agent_manifest() {
    local agent_name="$1"
    local strategy="$2"
    local tier="$3"
    local capital="$4"
    
    log_info "Creating manifest for $agent_name ($tier tier)..."
    
    # Get Vertex AI model for this agent
    local vertex_model
    vertex_model=$(get_vertex_model_for_agent "$agent_name")
    
    # Get model temperature and max tokens (agent-specific)
    local model_temp
    model_temp=$(get_model_temperature "$agent_name")
    local max_tokens
    max_tokens=$(get_max_tokens "$agent_name")
    
    # Get resource values based on tier
    case "$tier" in
        lightweight)
            CPU_REQ="100m"
            MEM_REQ="128Mi"
            CPU_LIM="300m"
            MEM_LIM="256Mi"
            ;;
        standard)
            CPU_REQ="300m"
            MEM_REQ="384Mi"
            CPU_LIM="800m"
            MEM_LIM="768Mi"
            ;;
        heavy)
            CPU_REQ="800m"
            MEM_REQ="1536Mi"
            CPU_LIM="2000m"
            MEM_LIM="3072Mi"
            ;;
        accelerated)
            CPU_REQ="1500m"
            MEM_REQ="2048Mi"
            CPU_LIM="4000m"
            MEM_LIM="8192Mi"
            ;;
        *)
            log_error "Unknown tier: $tier"
            exit 1
            ;;
    esac
    
    # Create agent manifest
    cat << AGENT_EOF
apiVersion: v1
kind: ConfigMap
metadata:
  name: ${agent_name}-config
  namespace: $NAMESPACE
  labels:
    agent: $agent_name
    tier: $tier
    component: configuration
data:
  AGENT_NAME: "${agent_name}"
  AGENT_STRATEGY: "${strategy}"
  CAPITAL_ALLOCATION: "${capital}"
  RISK_LEVEL: "medium"
  TIER: "${tier}"
  REDIS_URL: "redis://redis-service:6379"
  COORDINATOR_URL: "http://coordinator-service:8080"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: $agent_name
  namespace: $NAMESPACE
  labels:
    agent: $agent_name
    tier: $tier
    component: trading-agent
spec:
  replicas: 1
  selector:
    matchLabels:
      agent: $agent_name
  template:
    metadata:
      labels:
        agent: $agent_name
        tier: $tier
        component: trading-agent
    spec:
      containers:
      - name: $agent_name
        image: us-central1-docker.pkg.dev/sapphireinfinite/cloud-run-source-deploy/cloud-trader:latest
        ports:
        - containerPort: 8080
        env:
        - name: AGENT_NAME
          valueFrom:
            configMapKeyRef:
              name: ${agent_name}-config
              key: AGENT_NAME
        - name: AGENT_STRATEGY
          valueFrom:
            configMapKeyRef:
              name: ${agent_name}-config
              key: AGENT_STRATEGY
        - name: CAPITAL_ALLOCATION
          valueFrom:
            configMapKeyRef:
              name: ${agent_name}-config
              key: CAPITAL_ALLOCATION
        - name: RISK_LEVEL
          valueFrom:
            configMapKeyRef:
              name: ${agent_name}-config
              key: RISK_LEVEL
        - name: TIER
          valueFrom:
            configMapKeyRef:
              name: ${agent_name}-config
              key: TIER
        - name: REDIS_URL
          valueFrom:
            configMapKeyRef:
              name: ${agent_name}-config
              key: REDIS_URL
        - name: COORDINATOR_URL
          valueFrom:
            configMapKeyRef:
              name: ${agent_name}-config
              key: COORDINATOR_URL
        - name: AGENT_ID
          value: "${agent_name}"
        - name: ENABLE_VERTEX_AI
          value: "true"
        - name: MCP_ENABLED
          value: "true"
        - name: VERTEX_MODEL
          value: "${vertex_model}"
        - name: AGENT_ROLE
          valueFrom:
            configMapKeyRef:
              name: ${agent_name}-config
              key: AGENT_STRATEGY
        - name: MODEL_TEMPERATURE
          value: "${model_temp}"
        - name: MAX_OUTPUT_TOKENS
          value: "${max_tokens}"
        - name: QUANTIZATION_LEVEL
          value: "int8"
        # Trading API credentials (from secrets)
        - name: ASTER_API_KEY
          valueFrom:
            secretKeyRef:
              name: aster-dex-credentials
              key: api_key
        - name: ASTER_API_SECRET
          valueFrom:
            secretKeyRef:
              name: aster-dex-credentials
              key: api_secret
        - name: TELEGRAM_BOT_TOKEN
          valueFrom:
            secretKeyRef:
              name: telegram-secret
              key: TELEGRAM_BOT_TOKEN
        - name: TELEGRAM_CHAT_ID
          valueFrom:
            secretKeyRef:
              name: telegram-secret
              key: TELEGRAM_CHAT_ID
        resources:
          requests:
            memory: "$MEM_REQ"
            cpu: "$CPU_REQ"
          limits:
            memory: "$MEM_LIM"
            cpu: "$CPU_LIM"
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: ${agent_name}-service
  namespace: $NAMESPACE
  labels:
    agent: $agent_name
    tier: $tier
    component: service
spec:
  selector:
    agent: $agent_name
  ports:
  - port: 8080
    targetPort: 8080
AGENT_EOF
}

# Deploy agents
deploy_agents() {
    log_info "Deploying multi-agent ensemble..."
    
    # Define agents: name, strategy, tier, capital
    # All 6 specialized AI agents with $500 capital allocation each
    local agents=(
        "trend-momentum-agent:momentum-analysis:standard:500"
        "strategy-optimization-agent:strategy-optimization:standard:500"
        "financial-sentiment-agent:sentiment-analysis:standard:500"
        "market-prediction-agent:market-prediction:standard:500"
        "volume-microstructure-agent:volume-analysis:standard:500"
        "vpin-hft:vpin-hft-analysis:heavy:500"
    )
    
    for agent_spec in "${agents[@]}"; do
        IFS=':' read -r name strategy tier capital <<< "$agent_spec"
        
        log_info "Deploying $name ($tier tier, $$capital capital)..."
        
        # Create manifest
        local manifest_file="/tmp/${name}-manifest.yaml"
        create_agent_manifest "$name" "$strategy" "$tier" "$capital" > "$manifest_file"
        
        # Apply manifest
        if kubectl apply -f "$manifest_file"; then
            log_success "$name deployment initiated"
        else
            log_error "$name deployment failed"
            cat "$manifest_file"
            exit 1
        fi
        
        # Clean up temp file
        rm -f "$manifest_file"
    done
}

# Validate agent deployments
validate_agents() {
    log_info "Validating agent deployments..."
    
    local agents=("trend-momentum-agent" "strategy-optimization-agent" "financial-sentiment-agent" "market-prediction-agent" "volume-microstructure-agent" "vpin-hft")
    
    for agent in "${agents[@]}"; do
        log_info "Validating $agent..."
        
        # Wait for deployment to be ready
        if kubectl wait --for=condition=available --timeout=180s deployment/"$agent" -n "$NAMESPACE" 2>/dev/null; then
            log_success "$agent is ready"
        else
            log_error "$agent failed to become ready"
            kubectl describe deployment "$agent" -n "$NAMESPACE"
            kubectl logs deployment/"$agent" -n "$NAMESPACE" --tail=20
            exit 1
        fi
    done
    
    log_success "All agents validated successfully"
}

# Show final status
show_final_status() {
    echo ""
    log_info "MULTI-AGENT DEPLOYMENT COMPLETE"
    echo "================================"
    kubectl get deployments -n "$NAMESPACE" -l component=trading-agent
    echo ""
    kubectl get pods -n "$NAMESPACE" -l component=trading-agent
    echo ""
    kubectl get services -n "$NAMESPACE" -l component=service
    echo ""
    log_success "ðŸŽ¯ 6 AI Trading Agents Successfully Deployed!"
    echo ""
    echo "ðŸ“Š Agent Distribution:"
    echo "   â€¢ Standard: 5 (trend-momentum, strategy-optimization, financial-sentiment, market-prediction, volume-microstructure)"
    echo "   â€¢ Heavy: 1 (vpin-hft)"
    echo ""
    echo "ðŸ’° Capital Allocation: \$3,000 total (\$500 per agent)"
    echo "âš¡ Resources: Optimized for tiered performance"
    echo "ðŸ”„ Auto-scaling: Ready for production load"
}

# Main execution
main() {
    echo "ðŸ¤– MULTI-AGENT DEPLOYMENT"
    echo "========================="
    echo "Namespace: $NAMESPACE"
    echo "Agents: 6 specialized trading agents"
    echo ""
    
    validate_infrastructure
    deploy_agents
    validate_agents
    show_final_status
    
    echo ""
    log_success "ðŸš€ MULTI-AGENT SYSTEM READY FOR LIVE TRADING!"
}

# Run main function
main "$@"
